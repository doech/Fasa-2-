import javax.swing.*;
import java.awt.event.ActionEvent;
import java.awt.event.ActionListener;
import java.awt.image.BufferedImage;
import javax.imageio.ImageIO;
import java.io.File;
import java.io.IOException;

public class MainGUI {
    private Mapa mapa; //instancia de mapa para gestionar peligros
    private Usuario usuario; //instancia usuario para gestionar puntuaciones a futuro
    private JPanel mapaPanel;
    private BufferedImage mapaImage; //se utilizara una imagen como mapa para poder mostrarlo al usuario en el sitio

    /**
     * constructor de la clase MainGUI
     */

    public MainGUI() {
        mapa = new Mapa(); // inicializa el mapa
        usuario = new Usuario("Juan", "juan@example.com"); // crea usuario automaticamente

        // cargar la imagen del mapa
        try {
            mapaImage = ImageIO.read(new File("mapa_zona16.png")); // Asegúrate de que la imagen esté en el directorio correcto
        } catch (IOException e) {
            e.printStackTrace();
        }

        JFrame frame = new JFrame("Gestión de Peligros");
        frame.setSize(400, 300);
        frame.setDefaultCloseOperation(JFrame.EXIT_ON_CLOSE);
        frame.setLayout(null);

        //panel para el mapa
        mapaPanel = new JPanel() {
            @Override
            protected void paintComponent(Graphics g) {
                super.paintComponent(g);
                dibujarMapa(g); // Llamar al método para dibujar el mapa
            }
        };
        mapaPanel.setPreferredSize(new Dimension(800, 400));
        frame.add(mapaPanel, BorderLayout.CENTER);

        //botones
        JPanel buttonPanel = new JPanel();
        JButton btnReportar = new JButton("Reportar Peligro");
        JButton btnMostrar = new JButton("Mostrar Peligros");
        JButton btnGuardar = new JButton("Guardar Peligros en CSV");

        buttonPanel.add(btnReportar);
        buttonPanel.add(btnMostrar);
        buttonPanel.add(btnGuardar);
        frame.add(buttonPanel, BorderLayout.SOUTH);

        //reportar peligro
        btnReportar.addActionListener(new ActionListener() {
            @Override
            public void actionPerformed(ActionEvent e) {
                String tipoPeligro = JOptionPane.showInputDialog("Ingrese el tipo de peligro:");
                String descripcionPeligro = JOptionPane.showInputDialog("Ingrese la descripción del peligro:");
                double latitud = Double.parseDouble(JOptionPane.showInputDialog("Ingrese la latitud:"));
                double longitud = Double.parseDouble(JOptionPane.showInputDialog("Ingrese la longitud:"));
                int gravedad = Integer.parseInt(JOptionPane.showInputDialog("Ingrese la gravedad (1-5):"));
                String carril = JOptionPane.showInputDialog("Ingrese el carril (izquierdo/derecho):");

                Peligro peligro = new Peligro(tipoPeligro, descripcionPeligro, latitud, longitud, gravedad, carril);
                mapa.agregarPeligro(peligro);
                usuario.agregarPuntos(10); // agrega puntos al usuario

                JOptionPane.showMessageDialog(frame, "Peligro reportado exitosamente.");
                mapaPanel.repaint();
            }
        });
    //mostrar peligros reportados
    btnMostrar.addActionListener(new ActionListener() {
            @Override
            public void actionPerformed(ActionEvent e) {
                StringBuilder peligrosList = new StringBuilder("Peligros reportados:\n");
                for (Peligro p : mapa.getPeligros()) {
                    peligrosList.append(p.getTipo()).append(" - ").append(p.getDescripcion()).append("\n");
                }
                JOptionPane.showMessageDialog(frame, peligrosList.toString());
            }
        });

    // guardar en csv
    btnGuardar.addActionListener(new ActionListener() {
            @Override
            public void actionPerformed(ActionEvent e) {
                mapa.guardarPeligrosCSV("peligros.csv");
                JOptionPane.showMessageDialog(frame, "Peligros guardados en CSV.");
            }
        });

    frame.setVisible(true); //muestra frame (ventana)
}


//metodo para implementar peligros en imagen del mapa
private void dibujarMapa(Graphics g) {
        // dibujar la imagen del mapa
        if (mapaImage != null) {
            g.drawImage(mapaImage, 0, 0, mapaPanel.getWidth(), mapaPanel.getHeight(), null);
        }

        // Luego dibuja los peligros en el mapa
        for (Peligro p : mapa.getPeligros()) {
            // Convertir latitud y longitud a coordenadas del panel
            // Ajusta según la escala del mapa
            int x = (int) (p.getLongitud() * 10); // Escalar longitud
            int y = (int) (p.getLatitud() * 10); // Escalar latitud

            g.setColor(Color.RED);
            g.fillOval(x, y, 10, 10); // Dibujar el peligro como un círculo
        }
    }
    /**
     * Método principal para iniciar la aplicación.
     */
    public static void main(String[] args) {
        new MainGUI(); // creainstancia de MainGUI
    }
}
